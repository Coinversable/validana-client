!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports,require("raven-js"),require("bitcoinjs-lib")):"function"==typeof define&&define.amd?define("validana-client",["exports","raven-js","bitcoinjs-lib"],t):t(e["validana-client"]={},e.ravenJs,e.bitcoinjsLib)}(this,function(e,n,o){"use strict";var i=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r])};function s(e,t){function r(){this.constructor=e}i(e,t),e.prototype=null===t?Object.create(t):(r.prototype=t.prototype,new r)}function f(t,s,a,c){return new(a||(a=Promise))(function(e,r){function n(e){try{i(c.next(e))}catch(t){r(t)}}function o(e){try{i(c["throw"](e))}catch(t){r(t)}}function i(t){t.done?e(t.value):new a(function(e){e(t.value)}).then(n,o)}i((c=c.apply(t,s||[])).next())})}function x(r,n){var o,i,s,e,a={label:0,sent:function(){if(1&s[0])throw s[1];return s[1]},trys:[],ops:[]};return e={next:t(0),"throw":t(1),"return":t(2)},"function"==typeof Symbol&&(e[Symbol.iterator]=function(){return this}),e;function t(t){return function(e){return function(e){if(o)throw new TypeError("Generator is already executing.");for(;a;)try{if(o=1,i&&(s=2&e[0]?i["return"]:e[0]?i["throw"]||((s=i["return"])&&s.call(i),0):i.next)&&!(s=s.call(i,e[1])).done)return s;switch(i=0,s&&(e=[2&e[0],s.value]),e[0]){case 0:case 1:s=e;break;case 4:return a.label++,{value:e[1],done:!1};case 5:a.label++,i=e[1],e=[0];continue;case 7:e=a.ops.pop(),a.trys.pop();continue;default:if(!(s=0<(s=a.trys).length&&s[s.length-1])&&(6===e[0]||2===e[0])){a=0;continue}if(3===e[0]&&(!s||e[1]>s[0]&&e[1]<s[3])){a.label=e[1];break}if(6===e[0]&&a.label<s[1]){a.label=s[1],s=e;break}if(s&&a.label<s[2]){a.label=s[2],a.ops.push(e);break}s[2]&&a.ops.pop(),a.trys.pop();continue}e=n.call(r,a)}catch(t){e=[6,t],i=0}finally{o=s=0}if(5&e[0])throw e[1];return{value:e[0]?e[1]:void 0,done:!0}}([t,e])}}}function k(e){var t="function"==typeof Symbol&&e[Symbol.iterator],r=0;return t?t.call(e):{next:function(){return e&&r>=e.length&&(e=void 0),{value:e&&e[r++],done:!e}}}}
/**
 * @license
 * Copyright Coinversable B.V. All Rights Reserved.
 *
 * Use of this source code is governed by a AGPLv3-style license that can be
 * found in the LICENSE file at https://validana.io/license
 */var p=function(){function r(){}return r.setReportErrors=function(e,t){r.reportErrors=!0,n.config(e,{autoBreadcrumbs:!1,ignoreUrls:t?[/localhost/]:[]}).install()},r.isReportingErrors=function(){return r.reportErrors},r.setUser=function(e){n.setUserContext({id:e})},r.setRelease=function(e){n.setRelease(e)},r.debug=function(e,t){r.Level<=r.Debug&&(console.debug!==undefined?console.debug(e+(t!==undefined?": "+t.stack:"")):console.info(e+(t!==undefined?": "+t.stack:"")))},r.info=function(e,t){r.Level<=r.Info&&(console.info(e+(t!==undefined?": "+t.stack:"")),r.reportErrors&&(t!==undefined?n.captureBreadcrumb({level:"info",message:e,data:{stack:t.stack}}):n.captureBreadcrumb({level:"info",message:e})))},r.warn=function(e,t){r.Level<=r.Warning&&(console.warn(e+(t!==undefined?": "+t.stack:"")),r.reportErrors&&(t!==undefined?n.captureBreadcrumb({level:"warning",message:e,data:{stack:t.stack}}):n.captureBreadcrumb({level:"warning",message:e})))},r.error=function(e,t){r.Level<=r.Error&&(console.error(e+(t!==undefined?": "+t.stack:"")),r.reportErrors&&(t!==undefined?n.captureException(t,{level:"error",extra:{message:e}}):n.captureMessage(e,{level:"error"})))},r.fatal=function(e,t){r.Level<=r.Fatal&&(console.error(e+(t!==undefined?": "+t.stack:"")),r.reportErrors&&(t!==undefined?n.captureException(t,{level:"fatal",extra:{message:e}}):n.captureMessage(e,{level:"fatal"})))},r}();p.reportErrors=!1,p.Debug=0,p.Info=1,p.Warning=2,p.Error=3,p.Fatal=4,p.None=5,p.Level=p.Error,p.options={tags:{clientVersion:"1.0.0"},extra:{}};
/**
 * @license
 * Copyright Coinversable B.V. All Rights Reserved.
 *
 * Use of this source code is governed by a AGPLv3-style license that can be
 * found in the LICENSE file at https://validana.io/license
 */
var t=require("md5"),a=require("randombytes"),l=require("buffer").Buffer,E=function(){function d(){}return d.hash160=function(e){return o.crypto.hash160(e)},d.hash256=function(e){return o.crypto.hash256(e)},d.ripemd160=function(e){return o.crypto.ripemd160(e)},d.sha1=function(e){return o.crypto.sha1(e)},d.sha256=function(e){return o.crypto.sha256(e)},d.md5=function(e){return l.from(t(e),"hex")},d.isHex=function(e){return 0===e.search(/^[0-9A-Fa-f]*$/)&&0==(1&e.length)},d.hexToBinary=function(e){return l.from(e,"hex")},d.binaryToHex=function(e){return e.toString("hex")},d.isBase58=function(e){return 0===e.search(/^[1-9A-HJ-NP-Za-km-z]*$/)},d.base58ToBinary=function(e){var t,r;if(0===e.length)return l.alloc(0);var n=[0];try{for(var o=k(e),i=o.next();!i.done;i=o.next()){var s=i.value,a=d.base58map[s];if(a===undefined)throw new Error("Invalid character.");for(var c=0;c<n.length;c++)a+=58*n[c],n[c]=255&a,a>>=8;for(;0<a;)n.push(255&a),a>>=8}}catch(f){t={error:f}}finally{try{i&&!i.done&&(r=o["return"])&&r.call(o)}finally{if(t)throw t.error}}for(var u=0;e[u]===d.base58chars[0]&&u<e.length-1;u++)n.push(0);return l.from(n.reverse())},d.binaryToBase58=function(e){if(0===e.length)return"";for(var t="",r=[0],n=0;n<e.length;n++){for(var o=e[n],i=0;i<r.length;i++)o+=r[i]<<8,r[i]=o%58,o=o/58|0;for(;0<o;)r.push(o%58),o=o/58|0}for(i=0;0===e[i]&&i<e.length-1;i++)t+=d.base58chars[0];for(i=r.length-1;0<=i;i--)t+=d.base58chars[r[i]];return t},d.isBase64=function(e){return 0===e.search(/^[\+\/-9A-Za-z]*={0,2}$/)&&0==(3&e.length)},d.base64ToBinary=function(e){return l.from(e,"base64")},d.binaryToBase64=function(e){return e.toString("base64")},d.isUtf8Postgres=function(e){return-1===e.indexOf("\0")},d.makeUtf8Postgres=function(e){return e.replace("\0","")},d.utf8ToBinary=function(e){return l.from(e,"utf8")},d.binaryToUtf8=function(e){return e.toString("utf8")},d.uInt8ToBinary=function(e){var t=l.alloc(1);return t.writeUInt8(e,0),t},d.binaryToUInt8=function(e){return e.readUInt8(0)},d.uInt16ToBinary=function(e){var t=l.alloc(2);return t.writeUInt16LE(e,0),t},d.binaryToUInt16=function(e){return e.readUInt16LE(0)},d.uInt32ToBinary=function(e){var t=l.alloc(4);return t.writeUInt32LE(e,0),t},d.binaryToUInt32=function(e){return e.readUInt32LE(0)},d.uLongToBinary=function(e){if(!Number.isSafeInteger(e)||e<0)throw new Error("Invalid number.");var t=l.allocUnsafe(8);return t.writeUInt32LE(e%4294967296,0),t.writeUInt32LE(e/4294967296,4),t},d.binaryToULong=function(e){var t=e.readUInt32LE(0)+4294967296*e.readUInt32LE(4);if(!Number.isSafeInteger(t))throw new Error("Invalid binary data.");return t},d.id=function(){try{return a(16)}catch(r){for(var e="",t=0;t<4;t++)e+=(16*Math.random()).toString(16).slice(2,10);return d.hexToBinary(e)}},d}();E.base58chars="123456789ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnopqrstuvwxyz",E.base58map=Object.keys(E.base58chars).reduce(function(e,t){return e[E.base58chars[parseInt(t,10)]]=parseInt(t,10),e},{});var r=function(){function e(){this.map={}}return e.prototype.setFromObject=function(e,t){var r,n;void 0===t&&(t=!0);try{for(var o=k(Object.keys(e)),i=o.next();!i.done;i=o.next()){var s=i.value;!t&&this.has(s)||(this.map[s]=e[s])}}catch(a){r={error:a}}finally{try{i&&!i.done&&(n=o["return"])&&n.call(o)}finally{if(r)throw r.error}}return this},e.prototype.setFromMap=function(e,t){var r,n;void 0===t&&(t=!0);try{for(var o=k(e.keys()),i=o.next();!i.done;i=o.next()){var s=i.value;!t&&this.has(s)||(this.map[s]=e.get(s))}}catch(a){r={error:a}}finally{try{i&&!i.done&&(n=o["return"])&&n.call(o)}finally{if(r)throw r.error}}return this},e.prototype.get=function(e){return this.map[e]},e.prototype.set=function(e,t){return this.map[e]=t,this},e.prototype.has=function(e){return this.map.hasOwnProperty(e)},e.prototype["delete"]=function(e){return delete this.map[e],this},e.prototype.keys=function(){return Object.keys(this.map)},e.prototype.values=function(){var e,t,r=[];try{for(var n=k(Object.keys(this.map)),o=n.next();!o.done;o=n.next()){var i=o.value;r.push(this.map[i])}}catch(s){e={error:s}}finally{try{o&&!o.done&&(t=n["return"])&&t.call(n)}finally{if(e)throw e.error}}return r},e.prototype.size=function(){return Object.keys(this.map).length},e.prototype.clear=function(){var e,t;try{for(var r=k(Object.keys(this.map)),n=r.next();!n.done;n=r.next()){var o=n.value;delete this.map[o]}}catch(i){e={error:i}}finally{try{n&&!n.done&&(t=r["return"])&&t.call(r)}finally{if(e)throw e.error}}return this},e.prototype.entries=function(){return Object.assign({},this.map)},e}(),c=function(){function e(){this.observers=new Array,this.changed=!1}return e.prototype.addObserver=function(e){-1===this.observers.indexOf(e)&&this.observers.push(e)},e.prototype.hasObserver=function(e){return-1!==this.observers.indexOf(e)},e.prototype.clearChanged=function(){this.changed=!1},e.prototype.countObservers=function(){return this.observers.length},e.prototype.deleteObserver=function(e){var t=this.observers.indexOf(e);-1<t&&this.observers.splice(t,1)},e.prototype.hasChanged=function(){return this.changed},e.prototype.notifyObservers=function(e){var t,r;if(this.hasChanged()){try{for(var n=k(this.observers),o=n.next();!o.done;o=n.next()){o.value.update(this,e)}}catch(i){t={error:i}}finally{try{o&&!o.done&&(r=n["return"])&&r.call(n)}finally{if(t)throw t.error}}this.clearChanged()}},e.prototype.setChanged=function(){this.changed=!0},e}(),d=require("buffer").Buffer,y={Yes:0,NoJustStarted:1,NoDisconnected:2,NoCrashed:3,NoNotSupported:4};
/**
 * @license
 * Copyright Coinversable B.V. All Rights Reserved.
 *
 * Use of this source code is governed by a AGPLv3-style license that can be
 * found in the LICENSE file at https://validana.io/license
 */y[y.Yes]="Yes",y[y.NoJustStarted]="NoJustStarted",y[y.NoDisconnected]="NoDisconnected",y[y.NoCrashed]="NoCrashed",y[y.NoNotSupported]="NoNotSupported";var u=function(t){function e(){var e=t.call(this)||this;return e.signMethod="hash256-ecdsa-compact",e.reconnectTimeout=5e3,e.maxReconnectTimeout=6e4,e.isInitialized=!1,e.connected=y.NoJustStarted,e.timeout=5e3,e.requestResponseMap=new r,e}return s(e,t),e.get=function(){return this.instance===undefined&&(this.instance=new e),this.instance},e.prototype.init=function(e,t,r,n,o,i){if(void 0===r&&(r=t),void 0===n&&(n="hash256-ecdsa-compact"),void 0===o&&(o=5e3),void 0===i&&(i=6e4),!this.isInitialized){if(this.isInitialized=!0,this.serviceURL=t,this.processURL=r,this.serviceURL.endsWith("/")||(this.serviceURL+="/"),this.processURL.endsWith("/")||(this.processURL+="/"),this.processURL!==this.serviceURL&&"http"!==this.processURL.slice(0,4))throw new Error("processURL should be the same as serviceURL or a http(s) url");this.signPrefix=E.utf8ToBinary(e),this.signMethod=n,this.reconnectTimeout=o,this.maxReconnectTimeout=i,this.createWebsocket()}},e.prototype.isConnected=function(){return this.connected},e.prototype.sign=function(e,t,r){var n;switch(r){case"hash256-ecdsa-compact":default:n=t.sign(e)}return n},e.prototype.processTx=function(b,g,m,w){return void 0===w&&(w=0),f(this,void 0,void 0,function(){var r,n,o,i,s,a,c,u,f,d,l,h,p,y,v;return x(this,function(e){switch(e.label){case 0:return[4,this.query("contracts",undefined,!0)];case 1:s=e.sent(),e.label=2;case 2:e.trys.push([2,13,14,15]),a=k(s),c=a.next(),e.label=3;case 3:if(c.done)return[3,12];if((u=c.value).type!==g)return[3,11];if(Object.keys(u.template).length!==Object.keys(m).length)throw new Error("Payload not valid for contract.");try{for(f=k(Object.keys(u.template)),d=f.next();!d.done;d=f.next())if(l=d.value,m[l]===undefined)throw new Error("Payload not valid for contract.")}catch(t){o={error:t}}finally{try{d&&!d.done&&(i=f["return"])&&i.call(f)}finally{if(o)throw o.error}}h=E.id(),e.label=4;case 4:return e.trys.push([4,10,,11]),[4,this.signAndSend(b,h,E.hexToBinary(u.hash),m,w)];case 5:e.sent(),e.label=6;case 6:return e.trys.push([6,8,,9]),[4,this.getProcessedTx(h)];case 7:return[2,e.sent()];case 8:throw p=e.sent(),new Error("Transaction delivered, but unable to determine status: "+p.message);case 9:return[3,11];case 10:throw y=e.sent(),new Error("Failed to deliver transaction: "+y.message);case 11:return c=a.next(),[3,3];case 12:return[3,15];case 13:return v=e.sent(),r={error:v},[3,15];case 14:try{c&&!c.done&&(n=a["return"])&&n.call(a)}finally{if(r)throw r.error}return[7];case 15:throw new Error("Contract does not exist (anymore).")}})})},e.prototype.signAndSend=function(i,s,a,c,u){return void 0===u&&(u=0),f(this,void 0,void 0,function(){var t,r,n,o;return x(this,function(e){if(!this.isInitialized)throw new Error("Coinversable is not initialized.");return t=d.concat([E.uInt8ToBinary(1),s,a,E.uLongToBinary(u),E.utf8ToBinary(JSON.stringify(c))]),r=i.getPublicKey(),n=this.sign(d.concat([this.signPrefix,t]),i,this.signMethod),o={base64tx:E.binaryToBase64(d.concat([E.uInt32ToBinary(t.length+r.length+n.length),t,n,r])),createTs:Date.now()},[2,this.query("process",o,!0)]})})},e.prototype.getProcessedTx=function(r){return f(this,void 0,void 0,function(){return x(this,function(e){return[2,new Promise(function(e,t){return new h(r,e,t)})]})})},e.prototype.query=function(i,s,a){return void 0===a&&(a=!1),f(this,void 0,void 0,function(){var r,t,n,o=this;return x(this,function(e){if("process"===i&&(this.processURL!==this.serviceURL||!this.isInitialized)){if(this.isInitialized)return[2,new Promise(function(e,t){var r=new XMLHttpRequest;r.onreadystatechange=function(){4===r.readyState&&(200===r.status?e(r.responseText):t(""!==r.responseText?r.responseText:"Failed to connect."))},r.open("POST",o.processURL+"process",!0),r.send(JSON.stringify(s))})];throw new Error("Coinversable not initialized")}if(r=E.binaryToHex(E.id()),t={type:i,id:r},s!==undefined&&(t.data=s),this.webSocket===undefined||this.webSocket.readyState!==WebSocket.OPEN){if(this.connected!==y.NoCrashed&&this.connected!==y.NoNotSupported){if(a)throw new Error("No connection");return[2,new Promise(function(e,t){return o.requestResponseMap.set(r,{type:i,data:s,resolve:e,reject:t})})]}throw new Error("Connection to backend crashed.")}return n=JSON.stringify(t),p.debug("Request: "+n),this.webSocket.send(n),[2,new Promise(function(e,t){return o.requestResponseMap.set(r,{type:i,data:s,resolve:e,reject:t})})]})})},e.prototype.createWebsocket=function(){var h=this;this.webSocket=new WebSocket(this.serviceURL),this.webSocket.onopen=function(){var e,t;h.connected=y.Yes;try{for(var r=k(h.requestResponseMap.keys()),n=r.next();!n.done;n=r.next()){var o=n.value,i=h.requestResponseMap.get(o);h.query(i.type,i.data).then(i.resolve)["catch"](i.reject),h.requestResponseMap["delete"](o)}}catch(s){e={error:s}}finally{try{n&&!n.done&&(t=r["return"])&&t.call(r)}finally{if(e)throw e.error}}h.setChanged(),h.notifyObservers(y.Yes),h.timeout=h.reconnectTimeout*(.5+Math.random())},this.webSocket.onmessage=function(e){var t;try{t=JSON.parse(e.data)}catch(n){return p.warn("Message data: "+e.data),void p.error("Received message is not valid json.",n)}if(t.id!==undefined){p.debug("Response: "+e.data);var r=h.requestResponseMap.get(t.id);r!==undefined?(t.error!==undefined?r.reject(new Error(t.error)):r.resolve(t.data),h.requestResponseMap["delete"](t.id)):p.warn("Received response to unknown request: "+e.data)}else p.debug("Push: "+e.data),t.error===undefined&&"string"==typeof t.pushType?(h.setChanged(),h.notifyObservers({type:t.pushType,data:t.data})):p.warn("Received invalid push message: "+e.data)},this.webSocket.onclose=function(e){var t,r,n,o;if(1001===e.code)p.info("Server going offline, reconnecting in a moment..."),h.connected=y.NoDisconnected,h.setChanged();else if(4100===e.code){try{for(var i=k(h.requestResponseMap.keys()),s=i.next();!s.done;s=i.next()){var a=s.value;h.requestResponseMap.get(a).reject(new Error("Version of api not supported.")),h.requestResponseMap["delete"](a)}}catch(d){t={error:d}}finally{try{s&&!s.done&&(r=i["return"])&&r.call(i)}finally{if(t)throw t.error}}h.connected=y.NoNotSupported,h.setChanged()}else if(h.connected===y.Yes){try{for(var c=k(h.requestResponseMap.keys()),u=c.next();!u.done;u=c.next()){a=u.value;var f=h.requestResponseMap.get(a).data;p.warn("Outstanding requests: "+a+": type: "+h.requestResponseMap.get(a).type+" data: "+(f!==undefined?JSON.stringify(f):undefined)),h.requestResponseMap.get(a).reject(new Error("Connection to backend crashed.")),h.requestResponseMap["delete"](a)}}catch(l){n={error:l}}finally{try{u&&!u.done&&(o=c["return"])&&o.call(c)}finally{if(n)throw n.error}}p.error("Error in websocket connection, reconnecting in a moment..."),h.connected=y.NoCrashed,h.setChanged()}else h.connected===y.NoJustStarted?p.info("Failed to connect, trying again in a moment..."):p.info("Failed to reconnect, trying again in a moment...");h.notifyObservers(h.connected),h.connected!==y.NoNotSupported&&(setTimeout(function(){return h.createWebsocket()},Math.min(h.timeout,h.maxReconnectTimeout)),h.timeout*=1.5)}},e}(c);u.instance=undefined;var h=function(){function e(e,t,r){var n=this;this.id=E.binaryToHex(e),this.resolve=t,this.reject=r,u.get().addObserver(this),u.get().query("transaction",{txId:this.id,push:!0},!0).then(function(e){e!==undefined&&(u.get().deleteObserver(n),n.resolve(e))})["catch"](function(e){n.reject(e)})}return e.prototype.update=function(e,t){var r=this;"object"==typeof t&&"transaction"===t.type&&t.data.id===this.id?(u.get().deleteObserver(this),this.resolve(t.data)):t===y.Yes&&u.get().query("transaction",{txId:this.id,push:!0},!0).then(function(e){e!==undefined&&(u.get().deleteObserver(r),r.resolve(e))})["catch"](function(e){r.reject(e)})},e}(),v=require("buffer").Buffer,b=function(){function e(e){if(e instanceof v)this.key=o.ECPair.fromPublicKeyBuffer(e,o.networks.bitcoin);else{if(!(e instanceof o.ECPair))throw new Error("Invalid type for public key");this.key=e}if(!this.key.compressed)throw new Error("Only compressed keys are supported.")}return e.prototype.getPublicKey=function(){return this.key.getPublicKeyBuffer()},e.isValidPublic=function(e){try{return o.ECPair.fromPublicKeyBuffer(e,o.networks.bitcoin).compressed}catch(t){return!1}},e.isValidAddress=function(e){if("string"!=typeof e)return!1;try{var t=E.base58ToBinary(e),r=t.slice(-4);return 0===t[0]&&E.hash256(t.slice(0,-4)).slice(0,4).equals(r)}catch(n){return!1}},e.prototype.getAddress=function(){return this.address===undefined&&(this.address=this.key.getAddress()),this.address},e.verify=function(e,t,r){return o.ECPair.fromPublicKeyBuffer(e,o.networks.bitcoin).verify(t,o.ECSignature.parseCompact(v.concat([E.uInt8ToBinary(27),r])).signature)},e}(),g=function(t){function r(e){return t.call(this,e)||this}return s(r,t),r.generate=function(){return new r(o.ECPair.makeRandom({compressed:!0,network:o.networks.bitcoin}))},r.isValidWIF=function(e){try{return o.ECPair.fromWIF(e,o.networks.bitcoin).compressed}catch(t){return!1}},r.prototype.toWIF=function(){return this.key.toWIF()},r.fromWIF=function(e){var t=o.ECPair.fromWIF(e,o.networks.bitcoin);if(!t.compressed)throw new Error("Only compressed keys are supported.");return new r(t)},r.prototype.sign=function(e){return this.key.sign(E.hash256(e)).toCompact(0,!1).slice(1)},r}(b);
/**
 * @license
 * Copyright Coinversable B.V. All Rights Reserved.
 *
 * Use of this source code is governed by a AGPLv3-style license that can be
 * found in the LICENSE file at https://validana.io/license
 */e.Client=u,e.Connected=y,e.PrivateKey=g,e.PublicKey=b,e.Crypto=E,e.StringMap=r,e.Log=p,e.VObservable=c,Object.defineProperty(e,"__esModule",{value:!0})});
//# sourceMappingURL=validana-client.umd.min.js.map
